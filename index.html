<!doctype html>

<html>
  <head>
    <!-- <script src="http://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script> -->


    <script type="text/javascript"
        integrity="sha384-Jk2KQmxNIrlZNY8bE1bEnOjnx9PkvpwWgH/MEBCK+gpks+KdtHLnr2RzmMseDrGh"
        crossorigin="anonymous"
        src="https://cdn-cors.ethers.io/lib/ethers-5.5.4.umd.min.js">
    </script>

    <!-- IPFS upload example using Infura: https://genesis.re/kleros-metaevidence-metahash/ -->
    <script src="https://unpkg.com/ipfs-http-client@30.1.3/dist/index.js"></script>
    <script src="https://bundle.run/buffer@5.2.1"></script>


    <script src='http://ajax.googleapis.com/ajax/libs/angularjs/1.8.2/angular.min.js'></script>
    <script src='http://ajax.googleapis.com/ajax/libs/angularjs/1.8.2/angular-route.js'></script>

    <script src='https://cdnjs.cloudflare.com/ajax/libs/angular-ui-bootstrap/2.5.6/ui-bootstrap.js'></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/angular-ui-bootstrap/2.5.6/ui-bootstrap-tpls.min.js'></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">

    <noscript><link href="css/no-js.css" /> </noscript>


  </head>
  <body>

    <span id="javascript-required" style="display:none">
      <h1>Need to have JavaScript enabled</h1>
    </span>

    <span id="metamask-required" style="display:none">
      <h1>Need to have MetaMask installed: <a href="https://metamask.io">metamask.io</a></h1>
    </span>

    <span id="metamask-ok" style="display:none">
      <div class="menu">
        <a href="#!/home">home</a>
        <a href="#!/reports">reports</a>
        <a href="#!/orgs">orgs</a>
      </div>

      <div ng-view></div>
    </span>

  </body>

  <script src='js/abi.js'></script>
    <script>
      // THINK: do we require MetaMask to access the website?
      // For the time being yes, as it allows to read the data
      // TODO: obviously do not require it

      async function initializeETH() {

        let signer, provider;
        try {
          provider = new ethers.providers.Web3Provider(window.ethereum)

          // MetaMask requires requesting permission to connect users accounts
          await provider.send("eth_requestAccounts", []);

          // The MetaMask plugin also allows signing transactions to
          // send ether and pay to change state within the blockchain.
          // For this, you need the account signer...
          signer = provider.getSigner()
        } catch {
          console.error("Initialising MetaMask failed");
          document.getElementById("metamask-required").style.display = "block";
          return;
        }

        // We are properly initialised now
        document.getElementById("metamask-ok").style.display = "block";


        // const tx = signer.sendTransaction({
        //     to: "0x4724e90C7E773AAd8123B79A236A9717A9F5Ae1f",
        //     value: ethers.utils.parseEther("1.0")
        // });

        contract = new ethers.Contract("0x693140cf099E42A0B915897299839658cd3c49f0" , abi , signer)

        organisationsLength = (await contract.organisationsLength()).toNumber();

        let arrayOfPromises = [];
        for (let i=0; i<organisationsLength; i++) {
          arrayOfPromises.push(contract.organisations(i))
        }
        organisationNames = await Promise.all(arrayOfPromises);

        // console.log(organisationNames);

        // https://docs.angularjs.org/guide/bootstrap
        // Examples of when you'd need to do this include using script loaders or the need to perform an operation before AngularJS compiles a page.

        angular.element(function() {
          angular.bootstrap(document, ['app']);
        });

      }

      initializeETH();
    </script>

  <script src="js/main.js"></script>
  <script src="js/ctrl/home.js"></script>
  <script src="js/ctrl/reports.js"></script>
  <script src="js/ctrl/orgs.js"></script>
  <script src="js/ctrl/evaluateModal.js"></script>
  <script src="js/ctrl/newOrganisationModal.js"></script>
  <script src="js/services/data.js"></script>
  <script src="js/services/ipfs.js"></script>
  <script src="js/utils/filters.js"></script>

  <script>
    if(document.location.origin.includes("localhost")) {
      document.write('<script src="http://' + (location.host || 'localhost').split(':')[0] + ':35729/livereload.js?snipver=1"></' + 'script>')
    }
  </script>
</html>